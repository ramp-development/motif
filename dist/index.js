"use strict";(()=>{var Ce=Object.defineProperty;var we=(u,i,e)=>i in u?Ce(u,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[i]=e;var a=(u,i,e)=>we(u,typeof i!="symbol"?i+"":i,e);var M=class M{constructor(i={}){a(this,"events",new Map);a(this,"config");a(this,"handlerIdCounter",0);this.config={maxListeners:i.maxListeners??0,errorHandler:i.errorHandler??this.defaultErrorHandler,debug:i.debug??!1}}static getInstance(i){return M.instance||(M.instance=new M(i)),M.instance}on(i,e,t={}){this.events.has(i)||this.events.set(i,[]);let r=this.events.get(i);this.config.maxListeners>0&&r.length>=this.config.maxListeners&&console.error(`[EventBus] Max listeners (${this.config.maxListeners}) reached for event "${String(i)}"`),this.handlerIdCounter+=1;let n={handler:e,options:t,id:`handler-${this.handlerIdCounter}`},s=t.priority??0,o=r.findIndex(l=>(l.options.priority??0)<s);return o===-1?r.push(n):r.splice(o,0,n),()=>{this.off(i,e)}}once(i,e){return this.on(i,e,{once:!0})}off(i,e){let t=this.events.get(i);if(!t)return;if(!e){this.events.delete(i);return}let r=t.findIndex(n=>n.handler===e);r!==-1&&t.splice(r,1),t.length===0&&this.events.delete(i)}emit(i,e,t={}){let r=this.events.get(i);if(!r||r.length===0)return;let n=[...r];for(let s of n)try{let o=s.options.context??void 0;s.handler.call(o,e),s.options.once&&this.off(i,s.handler)}catch(o){if(t.throwOnError)throw o;this.config.errorHandler(o,String(i))}}async emitAsync(i,e,t={}){let r=this.events.get(i);if(!r||r.length===0)return;let n=[...r],s=[];for(let o of n){let l=(async()=>{try{let d=o.options.context??void 0;await o.handler.call(d,e),o.options.once&&this.off(i,o.handler)}catch(d){if(t.throwOnError)throw d;this.config.errorHandler(d,String(i))}})();s.push(l)}await Promise.all(s)}listenerCount(i){return this.events.get(i)?.length??0}removeAllListeners(i){i?this.events.delete(i):this.events.clear()}setMaxListeners(i){this.config.maxListeners=i}getMaxListeners(){return this.config.maxListeners}setDebugMode(i){this.config.debug=i}defaultErrorHandler(i,e){console.error(`[EventBus] Error in handler for "${e}":`,i)}getEventNames(){return Array.from(this.events.keys())}hasListeners(i){return this.listenerCount(i)>0}destroy(){this.removeAllListeners(),M.instance===this&&(M.instance=void 0)}};a(M,"instance");var x=M;var V=class{constructor(){a(this,"prefix","toolkit_")}getFullKey(i){return`${this.prefix}${i}`}parseCookies(){let i={};return document.cookie.split(";").forEach(e=>{let[t,r]=e.trim().split("=");t&&r&&(i[t]=decodeURIComponent(r))}),i}setCookie(i,e,t){let r=encodeURIComponent(e),n=`${i}=${r}`;if(t?.ttl){let s=new Date(Date.now()+t.ttl);n+=`; expires=${s.toUTCString()}`}n+=`; path=${t?.path||"/"}`,t?.domain&&(n+=`; domain=${t.domain}`),t?.secure&&(n+="; secure"),t?.sameSite&&(n+=`; samesite=${t.sameSite}`),document.cookie=n}deleteCookie(i){document.cookie=`${i}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`}get(i){try{let e=this.getFullKey(i),r=this.parseCookies()[e];if(!r)return null;try{let n=JSON.parse(r);return n&&typeof n=="object"&&"_value"in n?n._expires&&n._expires<Date.now()?(this.deleteCookie(e),null):n._value:n}catch{return r}}catch(e){return console.error(`Failed to get cookie: ${i}`,e),null}}set(i,e,t){try{let r=this.getFullKey(i),n={_value:e,_created:Date.now(),_expires:t?.ttl?Date.now()+t.ttl:void 0},s=JSON.stringify(n);if(s.length>4096)throw new Error(`Cookie value too large: ${s.length} bytes`);this.setCookie(r,s,t)}catch(r){throw console.error(`Failed to set cookie: ${i}`,r),r}}remove(i){this.deleteCookie(this.getFullKey(i))}clear(){let i=this.parseCookies();Object.keys(i).forEach(e=>{e.startsWith(this.prefix)&&this.deleteCookie(e)})}has(i){return this.get(i)!==null}keys(){let i=this.parseCookies();return Object.keys(i).filter(e=>e.startsWith(this.prefix)).map(e=>e.substring(this.prefix.length))}size(){return this.keys().length}};var R=class{constructor(){a(this,"prefix","toolkit_")}getFullKey(i){return`${this.prefix}${i}`}isStorageAvailable(){try{let i="__toolkit_test__";return localStorage.setItem(i,"test"),localStorage.removeItem(i),!0}catch{return!1}}get(i){if(!this.isStorageAvailable())return null;try{let e=this.getFullKey(i),t=localStorage.getItem(e);if(!t)return null;let r=JSON.parse(t);return r&&typeof r=="object"&&"_value"in r?r._expires&&r._expires<Date.now()?(localStorage.removeItem(e),null):r._value:r}catch(e){return console.error(`Failed to get value from localStorage: ${i}`,e),null}}set(i,e,t){if(this.isStorageAvailable())try{let r=this.getFullKey(i),n={_value:e,_created:Date.now(),_expires:t?.ttl?Date.now()+t.ttl:void 0};localStorage.setItem(r,JSON.stringify(n))}catch(r){if(console.error(`Failed to set value in localStorage: ${i}`,r),r instanceof DOMException&&r.name==="QuotaExceededError"){this.clearExpired();try{let n=this.getFullKey(i);localStorage.setItem(n,JSON.stringify({_value:e,_created:Date.now()}))}catch{throw new Error("Storage quota exceeded and unable to clear space")}}}}remove(i){this.isStorageAvailable()&&localStorage.removeItem(this.getFullKey(i))}clear(){if(!this.isStorageAvailable())return;let i=[];for(let e=0;e<localStorage.length;e++){let t=localStorage.key(e);t?.startsWith(this.prefix)&&i.push(t)}i.forEach(e=>localStorage.removeItem(e))}has(i){return this.get(i)!==null}keys(){if(!this.isStorageAvailable())return[];let i=[];for(let e=0;e<localStorage.length;e++){let t=localStorage.key(e);t?.startsWith(this.prefix)&&i.push(t.substring(this.prefix.length))}return i}size(){return this.keys().length}clearExpired(){let i=this.keys(),e=Date.now();i.forEach(t=>{try{let r=this.getFullKey(t),n=localStorage.getItem(r);if(n){let s=JSON.parse(n);s._expires&&s._expires<e&&localStorage.removeItem(r)}}catch{localStorage.removeItem(this.getFullKey(t))}})}};var K=class{constructor(){a(this,"storage",new Map)}get(i){let e=this.storage.get(i);return e?e.expires&&e.expires<Date.now()?(this.storage.delete(i),null):e.value:null}set(i,e,t){let r={value:e};t?.ttl&&(r.expires=Date.now()+t.ttl),this.storage.set(i,r)}remove(i){this.storage.delete(i)}clear(){this.storage.clear()}has(i){return this.get(i)!==null}keys(){let i=Date.now();for(let[e,t]of this.storage.entries())t.expires&&t.expires<i&&this.storage.delete(e);return Array.from(this.storage.keys())}size(){return this.keys().length}};var O=class{constructor(){a(this,"prefix","toolkit_")}getFullKey(i){return`${this.prefix}${i}`}isStorageAvailable(){try{let i="__toolkit_test__";return sessionStorage.setItem(i,"test"),sessionStorage.removeItem(i),!0}catch{return!1}}get(i){if(!this.isStorageAvailable())return null;try{let e=this.getFullKey(i),t=sessionStorage.getItem(e);if(!t)return null;let r=JSON.parse(t);return r&&typeof r=="object"&&"_value"in r?r._expires&&r._expires<Date.now()?(sessionStorage.removeItem(e),null):r._value:r}catch(e){return console.error(`Failed to get value from sessionStorage: ${i}`,e),null}}set(i,e,t){if(this.isStorageAvailable())try{let r=this.getFullKey(i),n={_value:e,_created:Date.now(),_expires:t?.ttl?Date.now()+t.ttl:void 0};sessionStorage.setItem(r,JSON.stringify(n))}catch(r){if(console.error(`Failed to set value in sessionStorage: ${i}`,r),r instanceof DOMException&&r.name==="QuotaExceededError"){this.clearExpired();try{let n=this.getFullKey(i);sessionStorage.setItem(n,JSON.stringify({_value:e,_created:Date.now()}))}catch{throw new Error("Storage quota exceeded and unable to clear space")}}}}remove(i){this.isStorageAvailable()&&sessionStorage.removeItem(this.getFullKey(i))}clear(){if(!this.isStorageAvailable())return;let i=[];for(let e=0;e<sessionStorage.length;e++){let t=sessionStorage.key(e);t?.startsWith(this.prefix)&&i.push(t)}i.forEach(e=>sessionStorage.removeItem(e))}has(i){return this.get(i)!==null}keys(){if(!this.isStorageAvailable())return[];let i=[];for(let e=0;e<sessionStorage.length;e++){let t=sessionStorage.key(e);t?.startsWith(this.prefix)&&i.push(t.substring(this.prefix.length))}return i}size(){return this.keys().length}clearExpired(){let i=this.keys(),e=Date.now();i.forEach(t=>{try{let r=this.getFullKey(t),n=sessionStorage.getItem(r);if(n){let s=JSON.parse(n);s._expires&&s._expires<e&&sessionStorage.removeItem(r)}}catch{sessionStorage.removeItem(this.getFullKey(t))}})}};var C=class C{constructor(){a(this,"adapters");a(this,"defaultType","memory");a(this,"eventBus");this.eventBus=x.getInstance(),this.adapters=new Map,this.adapters.set("memory",new K),this.adapters.set("local",new R),this.adapters.set("session",new O),this.adapters.set("cookie",new V)}static getInstance(){return C.instance||(C.instance=new C),C.instance}static init(){C.getInstance()}getAdapter(i){let e=this.adapters.get(i);if(!e)throw new Error(`Storage adapter not found: ${i}`);return e}setDefaultType(i){if(!this.adapters.has(i))throw new Error(`Invalid storage type: ${i}`);this.defaultType=i}get(i,e=this.defaultType){try{let r=this.getAdapter(e).get(i);return this.eventBus.emit("storage:get",{key:i,type:e}),r}catch(t){return this.eventBus.emit("storage:error",{error:t,operation:"get",key:i}),null}}set(i,e,t=this.defaultType,r){try{this.getAdapter(t).set(i,e,r),this.eventBus.emit("storage:set",{key:i,value:e,type:t})}catch(n){throw this.eventBus.emit("storage:error",{error:n,operation:"set",key:i}),n}}remove(i,e=this.defaultType){try{this.getAdapter(e).remove(i),this.eventBus.emit("storage:remove",{key:i,type:e})}catch(t){this.eventBus.emit("storage:error",{error:t,operation:"remove",key:i})}}clear(i=this.defaultType){try{this.getAdapter(i).clear(),this.eventBus.emit("storage:clear",{type:i})}catch(e){this.eventBus.emit("storage:error",{error:e,operation:"clear"})}}has(i,e=this.defaultType){try{return this.getAdapter(e).has(i)}catch{return!1}}keys(i=this.defaultType){try{return this.getAdapter(i).keys()}catch{return[]}}size(i=this.defaultType){try{return this.getAdapter(i).size()}catch{return 0}}copy(i,e,t,r){try{let n=this.get(i,e);return n===null?!1:(this.set(i,n,t,r),!0)}catch{return!1}}move(i,e,t,r){try{return this.copy(i,e,t,r)?(this.remove(i,e),!0):!1}catch{return!1}}getStats(){let i={memory:{keys:0,available:!0},local:{keys:0,available:!0},session:{keys:0,available:!0},cookie:{keys:0,available:!0}};for(let[e,t]of this.adapters.entries())try{i[e]={keys:t.size(),available:!0}}catch{i[e]={keys:0,available:!1}}return i}};a(C,"instance");var F=C;var w=class w{constructor(){a(this,"storageManager");a(this,"migrations",new Map);this.storageManager=F.getInstance()}static getInstance(){return w.instance||(w.instance=new w),w.instance}static init(){w.getInstance()}save(i,e,t){try{let r=this.filterData(e,t),s={_data:t.serialize?t.serialize(r):this.defaultSerialize(r),_version:t.version||1,_saved:Date.now(),_key:t.key};this.storageManager.set(this.getStorageKey(i,t),s,t.storage,t.options)}catch(r){throw console.error(`Failed to persist data: ${i}`,r),r}}load(i,e){try{let t=this.storageManager.get(this.getStorageKey(i,e),e.storage);if(!t||!t._data)return null;let r=t._data;if(t._version!==(e.version||1)){let s=this.migrateData(e.key,r,t._version,e.version||1);s!==null&&(r=s)}return e.deserialize?e.deserialize(r):this.defaultDeserialize(r)}catch(t){return console.error(`Failed to load persisted data: ${i}`,t),null}}remove(i,e){try{this.storageManager.remove(this.getStorageKey(i,e),e.storage)}catch(t){console.error(`Failed to remove persisted data: ${i}`,t)}}registerMigration(i,e,t,r){this.migrations.has(i)||this.migrations.set(i,new Map),this.migrations.get(i).set(e,r)}migrate(i,e,t,r){this.registerMigration(i,e,t,r)}getPersistedKeys(i){let e=[];return["memory","local","session","cookie"].forEach(r=>{let s=this.storageManager.keys(r).filter(o=>o.startsWith(`${i}:`));e.push(...s)}),Array.from(new Set(e))}clearNamespace(i){let e=this.getPersistedKeys(i),t=["memory","local","session","cookie"];e.forEach(r=>{t.forEach(n=>{this.storageManager.has(r,n)&&this.storageManager.remove(r,n)})})}exportNamespace(i){let e=this.getPersistedKeys(i),t={},r=["memory","local","session","cookie"];return e.forEach(n=>{for(let s of r){let o=this.storageManager.get(n,s);if(o!==null){t[n]=o;break}}}),t}importNamespace(i,e,t="memory"){Object.entries(e).forEach(([r,n])=>{r.startsWith(`${i}:`)&&this.storageManager.set(r,n,t)})}getStorageKey(i,e){return`${e.key}:${i}`}filterData(i,e){if(!i||typeof i!="object")return i;let t=i,r={};return e.include&&e.include.length>0?(e.include.forEach(n=>{n in t&&(r[n]=t[n])}),r):(Object.entries(t).forEach(([n,s])=>{(!e.exclude||!e.exclude.includes(n))&&(r[n]=s)}),r)}defaultSerialize(i){if(i===null||typeof i=="string"||typeof i=="number"||typeof i=="boolean")return i;if(Array.isArray(i)||typeof i=="object"&&i!==null)return JSON.parse(JSON.stringify(i));throw new Error(`Cannot serialize data of type: ${typeof i}`)}defaultDeserialize(i){return i}migrateData(i,e,t,r){let n=this.migrations.get(i);if(!n)return console.warn(`No migrations found for key: ${i}`),e;let s=e,o=t;for(;o<r;){let l=n.get(o);l?s=l(s):console.warn(`No migration found from version ${o} to ${o+1}`),o+=1}return s}};a(w,"instance");var H=w;var A=class A{constructor(){a(this,"state",new Map);a(this,"stateConfigs",new Map);a(this,"eventBus");a(this,"persistenceManager");a(this,"namespace","app-state");this.eventBus=x.getInstance(),this.persistenceManager=H.getInstance()}static getInstance(){return A.instance||(A.instance=new A),A.instance}static init(){A.getInstance().restorePersistedState()}configure(i,e){this.stateConfigs.set(i,e),e.defaultValue!==void 0&&!this.state.has(i)&&this.set(i,e.defaultValue,{skipPersist:!0})}set(i,e,t){let r=this.state.get(i);this.state.set(i,e);let n=this.stateConfigs.get(i);n?.persistent&&!t?.skipPersist&&this.persistValue(i,e,n),this.eventBus.emit("state:changed",{key:i,from:r,to:e,timestamp:Date.now()})}get(i){return this.state.get(i)}getOrDefault(i,e){return this.state.has(i)?this.state.get(i):e}has(i){return this.state.has(i)}remove(i){let e=this.state.get(i),t=this.stateConfigs.get(i);this.state.delete(i),this.stateConfigs.delete(i),t?.persistent&&this.removePersistedValue(i,t),this.eventBus.emit("state:removed",{key:i,value:e,timestamp:Date.now()})}clear(i){let e=i?.keepPersisted?Array.from(this.stateConfigs.entries()).filter(([,t])=>t.persistent).map(([t])=>t):[];this.state.clear(),i?.keepPersisted?e.forEach(t=>{let r=this.stateConfigs.get(t);if(r){let n=this.loadPersistedValue(t,r);n!==null&&this.state.set(t,n)}}):(this.stateConfigs.clear(),this.persistenceManager.clearNamespace(this.namespace))}keys(){return Array.from(this.state.keys())}entries(){return Array.from(this.state.entries())}size(){return this.state.size}watch(i,e){let t=r=>{r.key===i&&e(r.to,r.from)};return this.eventBus.on("state:changed",t)}computed(i,e){return()=>{let t={};return i.forEach(r=>{t[r]=this.get(r)}),e(t)}}batch(i){Object.entries(i).forEach(([e,t])=>{this.set(e,t)})}export(i=!1){let e={};if(this.state.forEach((t,r)=>{e[r]=t}),i){let t={};return this.stateConfigs.forEach((r,n)=>{t[n]=r}),{state:e,configs:t}}return{state:e}}import(i){i.configs&&Object.entries(i.configs).forEach(([e,t])=>{this.configure(e,t)}),this.batch(i.state)}persistValue(i,e,t){let r={key:this.namespace,storage:t.storage||"local",version:1};try{this.persistenceManager.save(i,e,r)}catch(n){console.error(`Failed to persist state: ${i}`,n)}}loadPersistedValue(i,e){let t={key:this.namespace,storage:e.storage||"local",version:1};try{return this.persistenceManager.load(i,t)}catch(r){return console.error(`Failed to load persisted state: ${i}`,r),null}}removePersistedValue(i,e){let t={key:this.namespace,storage:e.storage||"local",version:1};try{this.persistenceManager.remove(i,t)}catch(r){console.error(`Failed to remove persisted state: ${i}`,r)}}restorePersistedState(){this.stateConfigs.forEach((i,e)=>{if(i.persistent&&!this.state.has(e)){let t=this.loadPersistedValue(e,i);t!==null&&this.set(e,t,{skipPersist:!0})}})}};a(A,"instance");var te=A;var re=class extends Error{constructor(e,t,r,n){super(e);this.componentId=t;this.phase=r;this.cause=n;this.name="ComponentError"}};var ie=class{constructor(i={}){a(this,"group");a(this,"id");a(this,"props");a(this,"metadata");a(this,"rootElement",null);a(this,"elements",new Map);this.metadata={name:this.constructor.name,initialized:!1,destroyed:!1},this.props=i,this.group=i.group,this.id=i.id||this.generateId(),i.autoInit&&this.init()}async init(){if(this.metadata.initialized){this.logWarn("Component already initialized");return}try{this.metadata.initTime=Date.now(),await this.onInit(),this.metadata.initialized=!0}catch(i){throw this.createError(`Failed to initialize: ${i}`,"init")}}async destroy(){if(this.metadata.destroyed){this.logWarn("Component already destroyed");return}try{this.metadata.destroyTime=Date.now(),await this.onDestroy(),this.elements.clear(),this.rootElement=null,this.metadata.destroyed=!0,this.metadata.initialized=!1,this.logDebug("Component destroyed")}catch(i){throw this.createError(`Failed to destroy: ${i}`,"destroy")}}query(i,e={}){let{required:t=!1,parent:r=this.rootElement||document}=e;if(i instanceof HTMLElement)return i;if(!i){if(t)throw this.createError("Selector is required","runtime");return null}let n=r.querySelector(i);if(!n&&t)throw this.createError(`Required element not found: ${i}`,"runtime");return n}queryAll(i,e={}){let{parent:t=this.rootElement||document}=e;return Array.from(t.querySelectorAll(i))}setRootElement(i,e){let t=this.query(i,{...e,required:!0});t&&(this.rootElement=t,t.dataset.componentId=this.id,this.props.className&&t.classList.add(this.props.className))}getRootElement(){return this.rootElement}cacheElement(i,e,t){let r=this.query(e,t);r&&this.elements.set(i,r)}getElement(i){return this.elements.get(i)||null}isInitialized(){return this.metadata.initialized&&!this.metadata.destroyed}isDestroyed(){return this.metadata.destroyed}getId(){return this.id}getMetadata(){return{...this.metadata}}generateId(){let i=crypto.randomUUID();return`${this.metadata.name}-${i}`}createError(i,e="runtime",t){return new re(`[${this.id}] ${i}`,this.id,e,t)}setText(i,e){i&&(i.textContent=e)}setHTML(i,e,t=!1){if(i)if(t){let r=document.createElement("div");r.textContent=e,i.innerHTML=r.innerHTML}else i.innerHTML=e}setAttribute(i,e,t){i&&i.setAttribute(e,t)}toggleVisibility(i,e){i&&(e===void 0?i.hidden=!i.hidden:i.hidden=!e)}toggleClass(i,e,t){i&&i.classList.toggle(e,t)}groupStart(i,e=!0){this.props.debug&&(e?console.groupCollapsed(i):console.group(i))}groupEnd(){console.groupEnd()}timeDebug(i,e=!1){this.props.debug&&(e&&console.timeEnd(i),e||console.time(i))}logDebug(...i){this.props.debug&&console.log(...i)}logWarn(...i){console.warn(...i)}logError(...i){console.error(...i)}logTable(i,e){console.table(i,e)}};var ne=class extends ie{constructor(e={}){super(e);a(this,"eventBus");a(this,"listeners",new Map);a(this,"eventUnsubscribers",[]);a(this,"delegatedHandlers",new Map);this.eventBus=x.getInstance({debug:!0})}async onInit(){await this.setupEventListeners(),this.props.events&&this.bindConfigEvents()}async onDestroy(){this.removeAllListeners(),this.removeAllSubscriptions(),this.removeDelegatedHandlers()}addEventListener(e,t,r,n){let s,o;if(typeof e=="string"){let l=this.getElement(e);if(!l){this.logWarn(`Cached element not found: ${e}`);return}s=l,o=`${e}-${t}`}else s=e,o=`${s.constructor.name}-${t}`;this.listeners.has(o)&&this.removeEventListener(o),s.addEventListener(t,r,n),this.listeners.set(o,{element:s,event:t,handler:r,options:n||void 0}),this.logDebug(`Added listener: ${o}`)}removeEventListener(e){let t=this.listeners.get(e);t&&(t.element.removeEventListener(t.event,t.handler,t.options),this.listeners.delete(e),this.logDebug(`Removed listener: ${e}`))}removeAllListeners(){this.listeners.forEach((e,t)=>{this.removeEventListener(t)})}delegate(e,t,r,n=document){let s=l=>{let m=l.target.closest(t);m&&n.contains(m)&&r.call(this,l,m)},o=`${e}-${t}`;this.delegatedHandlers.has(o)&&n.removeEventListener(e,this.delegatedHandlers.get(o)),n.addEventListener(e,s,!0),this.delegatedHandlers.set(o,s)}removeDelegatedHandlers(){this.delegatedHandlers.forEach((e,t)=>{let[r]=t.split("-");r&&document.removeEventListener(r,e,!0)}),this.delegatedHandlers.clear()}subscribe(e,t,r){let n=this.eventBus.on(e,t,r);this.eventUnsubscribers.push(n)}subscribeOnce(e,t){let r=this.eventBus.once(e,t);this.eventUnsubscribers.push(r)}removeAllSubscriptions(){this.eventUnsubscribers.forEach(e=>e()),this.eventUnsubscribers=[]}emit(e,t){this.eventBus.emit(e,t)}emitCustom(e,t,r){let n=r||this.rootElement||document.body,s=new CustomEvent(e,{detail:t,bubbles:!0,cancelable:!0});n.dispatchEvent(s)}bindConfigEvents(){let e=this.props;!e.events||!this.rootElement||Object.entries(e.events).forEach(([t,r])=>{this.addEventListener(this.rootElement,t,r.bind(this))})}onClick(e,t,r=0){let n=r>0?this.debounce(t,r):t;this.addEventListener(e,"click",n)}onInput(e,t,r=0){let n=r>0?this.debounce(t,r):t;this.addEventListener(e,"input",n)}debounce(e,t){let r=null;return(...n)=>{r!==null&&clearTimeout(r),r=setTimeout(()=>{e.apply(this,n)},t)}}async waitForElement(e,t=5e3,r=document){return new Promise((n,s)=>{let o=r.querySelector(e);if(o){n(o);return}let l=new MutationObserver((d,m)=>{let v=r.querySelector(e);v&&(m.disconnect(),n(v))});l.observe(r===document?document.body:r,{childList:!0,subtree:!0}),setTimeout(()=>{l.disconnect(),s(this.createError(`Element not found: ${e}`,"runtime"))},t)})}getActiveListeners(){return new Map(this.listeners)}getListenerCount(){return this.listeners.size+this.eventUnsubscribers.length}};var se=class extends ne{constructor(e={}){super(e);a(this,"state");a(this,"stateConfigs",new Map);a(this,"stateManager");a(this,"storageManager");a(this,"persistenceManager");a(this,"statePrefix");a(this,"initialState",{});this.state={},this.stateManager=te.getInstance(),this.storageManager=F.getInstance(),this.persistenceManager=H.getInstance(),this.statePrefix=e.statePrefix||this.id,e.state&&(Array.isArray(e.state)?e.state:[e.state]).forEach(r=>this.configureState(r))}async onInit(){await super.onInit(),this.restoreState(),this.subscribeToStateChanges()}async onDestroy(){this.props.persistState&&this.persistState(),await super.onDestroy()}configureState(e){let t=e.key;this.stateConfigs.set(t,e),e.defaultValue!==void 0&&(this.state[t]=e.defaultValue,this.initialState[t]=e.defaultValue)}getState(e){return this.state[e]}setState(e,t,r={}){let n=this.state[e];if(this.isEqual(n,t))return!1;let s=this.stateConfigs.get(e);if(s?.validate&&!s.validate(t))return this.logWarn(`State validation failed for ${String(e)}:`,t),!1;let o=s?.transform?s.transform(t):t;return this.state[e]=o,r.persist!==!1&&this.persistStateKey(e,o),r.silent||this.onStateChange(e,n,o),!0}setStates(e,t={}){let r=[];Object.entries(e).forEach(([n,s])=>{let o=n,l=this.state[o];this.setState(o,s,{...t,silent:!0})&&r.push({key:o,from:l,to:s})}),!t.silent&&r.length>0&&(this.logDebug("Batch state change",{changes:r}),r.forEach(({key:n,from:s,to:o})=>{this.onStateChange(n,s,o)}))}resetState(e){(e||Object.keys(this.state)).forEach(r=>{r in this.initialState&&this.setState(r,this.initialState[r])})}getAllState(){return{...this.state}}subscribeToStateChanges(){this.subscribe("state:changed",e=>{if(e.key.startsWith(this.statePrefix)){let t=e.key.replace(`${this.statePrefix}.`,"");t in this.state&&this.setState(t,e.to,{silent:!1,persist:!1})}})}onStateChange(e,t,r){this.emit("state:changed",{key:`${this.statePrefix}.${String(e)}`,from:t,to:r,timestamp:Date.now()}),this.handleStateChange(e,t,r)}persistStateKey(e,t){let r=this.stateConfigs.get(e);if(!r)return;let n={key:this.statePrefix,storage:r.storage||"memory",version:1};try{this.persistenceManager.save(String(e),t,n)}catch(s){this.logError(`Failed to persist state: ${String(e)}`,s)}}persistState(){Object.entries(this.state).forEach(([e,t])=>{this.persistStateKey(e,t)})}restoreState(){this.stateConfigs.forEach((e,t)=>{let r={key:this.statePrefix,storage:e.storage||"memory",version:1};try{let n=this.persistenceManager.load(String(t),r);n!==null&&this.setState(t,n,{silent:!0,persist:!1})}catch(n){this.logError(`Failed to restore state: ${String(t)}`,n)}})}isEqual(e,t){if(e===t)return!0;if(e==null||t==null||typeof e!="object"||typeof t!="object")return!1;let r=Object.keys(e),n=Object.keys(t);return r.length!==n.length?!1:r.every(s=>this.isEqual(e[s],t[s]))}createComputed(e,t){return()=>t(this.state)}watchState(e,t){let r=n=>{let{detail:s}=n;s.key===String(e)&&t(s.to,s.from)};return this.rootElement?.addEventListener("state:changed",r),()=>{this.rootElement?.removeEventListener("state:changed",r)}}};var p="data-form";var ge={byField:!0,byGroup:!0,bySet:!0,byCard:!0};var he={form:!0,card:!0,set:!0,group:!0,field:!0,input:!0,prev:!0,next:!0,submit:!0,error:!0,"progress-line":!0};var fe={native:!0};var ve={memory:!0};var ye={fade:!0,slide:!0,none:!0};var g=class u{static buildFromParent(i,e){let t={formId:e};return i&&(t[`${i.type}Id`]=i.id,t[`${i.type}Index`]=i.index,"parentHierarchy"in i&&i.parentHierarchy&&Object.assign(t,i.parentHierarchy)),t}static findParentHierarchy(i,e,t){let r;return i instanceof HTMLElement?r=t(i):r=i,u.buildFromParent(r,e.getId())}static findParentByElement(i,e,t){let r=i.closest(`[${p}-element^="${e}"]`);return r?t().find(o=>o.element===r):void 0}};var S=class{constructor(){a(this,"items",[]);a(this,"itemMap",new Map)}add(i){this.items.push(i),this.itemMap.set(i.id,i)}update(i){this.itemMap.set(i.id,i),this.items[i.index]=i}merge(i,e){let t={...i,...e};this.update(t)}getAll(){return this.items}getById(i){return this.itemMap.get(i)}getByIndex(i){return this.items.find(e=>e.index===i)}getBySelector(i){return typeof i=="string"?this.getById(i):this.getByIndex(i)}getByDOM(i){return this.items.find(e=>e.element===i)}filter(i){return this.items.filter(i)}find(i){return this.items.find(i)}clear(){this.items=[],this.itemMap.clear()}get length(){return this.items.length}};function ce(u){return u.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")}function Ae(u){return u.querySelector("legend")?.textContent?.trim()||null}function k(u,i,e,t){let r=u.getAttribute(`${p}-${i}title`);if(r?.trim()){let o=r.trim();return{title:o,source:"attribute",id:e||ce(o)}}if(i==="set"||i==="group"){let o=Ae(u);if(o)return{title:o,source:"legend",id:e||ce(o)}}if(e)return{title:e.split("-").map(l=>l.charAt(0).toUpperCase()+l.slice(1)).join(" "),source:"attribute",id:e};let n=`${i}-${t}`;return{title:`${i.charAt(0).toUpperCase()+i.slice(1)} ${t+1}`,source:"generated",id:n}}function be(u){let i={};return Array.from(u.attributes).forEach(e=>{if(e.name.startsWith(`${p}-`)){let t=e.name.replace(`${p}-`,"");i[t]=e.value}}),i}function B(u,i=!1){return u===void 0?i:u==="true"||u===""}function T(u,i){return u?u in i:!1}function $(u,i,e,t){if(!T(u,i)){let r=Object.keys(i).join(", "),n=t?`${t}: `:"";throw new Error(`${n}Invalid ${e} "${u}". Valid types are: ${r}`)}}function Ee(u){return T(u,ge)}function pe(u,i){$(u,he,"element type",i)}function Ie(u){return T(u,fe)}function Te(u){return T(u,ve)}function Se(u){return T(u,ye)}function f(u){let i=u.trim();if(i.includes(":")){let e=i.split(":"),t=e[0].trim();return pe(t),{type:t,id:e[1].trim()}}return pe(i),{type:i,id:void 0}}function Me(u,i){if(u===void 0)return i;let e=parseInt(u,10);return isNaN(e)?i:e}var L=(u,i)=>i===1?u:`${u}s`;var xe=u=>u.toLowerCase().replace(/(^\s*\w)/g,i=>i.toUpperCase());var h=class{constructor(i){a(this,"form");this.form=i}groupStart(i,e=!0){this.form.groupStart(i,e)}groupEnd(){this.form.groupEnd()}logDebug(...i){this.form.logDebug(...i)}logWarn(...i){this.form.logWarn(...i)}logError(...i){this.form.logError(...i)}logTable(i,e){this.form.logTable(i,e)}createError(i,e="runtime",t){return this.form.createError(i,e,t)}};var N=class extends h{constructor(){super(...arguments);a(this,"store",new S);a(this,"activeListeners",[]);a(this,"handleClick",e=>{if(e==="submit"){let t={};this.logDebug("Submit button clicked: requesting form submission"),this.form.emit("form:submit:request",t);return}this.logDebug(`${xe(e)} button clicked: requesting navigation`),this.form.emit("form:navigation:request",{type:e})})}init(){this.groupStart("Initializing Buttons"),this.discoverItems(),this.setupEventListeners(),this.applyStates(!0),this.logDebug("Initialized"),this.groupEnd()}destroy(){this.store.clear(),this.unbindAllButtons(),this.logDebug("ButtonManager destroyed")}discoverItems(){let e=this.form.getRootElement();if(!e)throw this.form.createError("Cannot discover navigation buttons: root element is null","init",{cause:e});let t=this.form.queryAll(`[${p}-element="prev"], [${p}-element="next"], [${p}-element="submit"]`);this.store.clear(),t.forEach((r,n)=>{let s=this.createItemData(r,n);s&&this.store.add(s)}),this.logDebug(`Discovered ${this.store.length} buttons`)}createItemData(e,t){if(!(e instanceof HTMLElement))return;let r=e.getAttribute(`${p}-element`);if(!r)return;let n=f(r);if(!["prev","next","submit"].includes(n.type))return;let s=e instanceof HTMLButtonElement?e:e.querySelector("button")??e.querySelector("a");if(!s)throw this.form.createError("Cannot discover navigation buttons: button is null","init",{cause:e});if(s instanceof HTMLAnchorElement)throw this.form.createError("Cannot discover navigation buttons: button is a link","init",{cause:e});let o=`${n.type}-button-${t}`;return this.buildItemData({element:e,index:t,id:o,active:!1,type:n.type,parentHierarchy:this.findParentHierarchy(e),button:s,originalText:this.getText(s),disabled:!0,visible:!1})}buildItemData(e){let t=this.determineActive(e.element),r=!0,n=this.determineEnabled(e.type,t&&r);return{...e,active:t,visible:r,disabled:!n}}determineActive(e){let t=this.findParentItem(e);return t?t.active:!0}determineVisible(e){let{current:t,total:r}=this.getRelevantState(),{currentCardIndex:n,totalCards:s,currentSetIndex:o,totalSets:l}=this.form.getAllState();switch(e){case"prev":return s>0&&n>0||l>0&&o>0;case"next":return t!==r-1;case"submit":return t===r-1}}determineEnabled(e,t=!0){if(!t)return!1;let r=this.form.inputManager.getByFilter(n=>n.active&&n.isIncluded).every(n=>n.isValid);switch(e){case"prev":return t;case"next":return r;case"submit":return r}}getRelevantState(){let e=this.form.getBehavior(),t=this.form.getAllState(),r,n;switch(e){case"byField":r=t.currentFieldIndex,n=t.totalFields;break;case"byGroup":r=t.currentGroupIndex,n=t.totalGroups;break;case"bySet":r=t.currentSetIndex,n=t.totalSets;break;case"byCard":r=t.currentCardIndex,n=t.totalCards;break;default:throw this.form.createError("Cannot determine button visibility: invalid behavior","init",{cause:e})}return{current:r,total:n}}findParentHierarchy(e){return g.findParentHierarchy(e,this.form,t=>this.findParentItem(t))}findParentItem(e){let t=g.findParentByElement(e,"set",()=>this.form.setManager.getAll()),r=g.findParentByElement(e,"card",()=>this.form.cardManager.getAll());return t??r}setupEventListeners(){this.bindActiveButtons(),this.form.subscribe("form:navigation:changed",()=>{this.calculateStates(),this.applyStates(),this.handleActiveButtons()}),this.form.subscribe("form:input:changed",()=>{this.calculateStates(),this.applyStates()}),this.form.subscribe("form:condition:evaluated",()=>{this.calculateStates(),this.applyStates()}),this.logDebug("Event listeners setup")}bindActiveButtons(){let e=this.getActive();e.length!==0&&e.forEach(t=>{let{button:r}=t;if(this.activeListeners.some(l=>l.button===r))return;let s=()=>{this.handleClick(t.type)};r.addEventListener("click",s),this.activeListeners.push({button:r,index:t.index,type:t.type,event:"click",handler:s});let o=this.findParentItem(t.element);o&&this.logDebug(`Bound "click" events to "${t.type}" button within ${o.type} "${o.id}"`)})}unbindInactiveButtons(){let e=this.getActive();e.length!==0&&(this.activeListeners=this.activeListeners.filter(t=>{let r=!e.find(n=>n.index===t.index);if(r){t.button.removeEventListener(t.event,t.handler);let n=this.findParentItem(t.button);n&&this.logDebug(`Unbound "${t.event}" events from "${t.type}" button within ${n.type} "${n.id}"`)}return!r}))}unbindAllButtons(){this.activeListeners.forEach(e=>{e.button.removeEventListener(e.event,e.handler)}),this.activeListeners=[]}calculateStates(){this.getAll().forEach(e=>{let t=this.buildItemData(e);this.store.update(t)})}handleActiveButtons(){this.unbindInactiveButtons(),this.bindActiveButtons()}applyStates(e=!1){this.logDebug(`${e?"Initializing":"Updating"} button states`),this.getAll().forEach(t=>{t.button.disabled=t.disabled,t.visible?t.element.style.removeProperty("display"):t.element.style.display="none"})}getAll(){return this.store.getAll()}getByType(e){return this.store.filter(t=>t.type===e)}getActive(){return this.store.filter(e=>e.active&&e.visible)}getAllByParent(e){return this.store.filter(t=>t.parentHierarchy===e)}getTypeByParent(e,t){return this.getAllByParent(e).filter(n=>n.type===t)}getText(e){let t=e.querySelector(`[${p}-element="button-text"]`);return t?t.textContent??"":e.textContent??""}setText(e,t){let r=e.dataset.button?e:e.closest("[data-button]");if(!r)return;let n=this.store.getByDOM(r),s=t??n?.originalText??"";if(!s)return;let o=r.querySelector(`[${p}-element="button-text"]`);o?o.textContent=s:e.textContent=s}getSubmit(){return this.store.getAll().find(e=>e.active&&e.type==="submit")}determineNextOrSubmit(){let e=this.getActive();return e.find(n=>n.type==="next")?(this.logDebug("Next button found"),"next"):e.find(n=>n.type==="submit")?(this.logDebug("Submit button found"),"submit"):"next"}};var I=class extends h{constructor(){super(...arguments);a(this,"store",new S);a(this,"navigationOrder",[])}init(e=!0){this.groupStart(`Initializing ${this.itemType}s`),this.discoverItems(),this.itemType!=="input"&&this.buildNavigationOrder(),this.setStates(),e&&this.onInitialized()}onInitialized(){this.logDebug("Initialized",{items:this.getAll()}),this.groupEnd()}destroy(){this.clear(),this.logDebug(`${this.constructor.name} destroyed`)}discoverItems(){let e=this.form.getRootElement();if(!e)throw this.createError(`Cannot discover ${this.itemType}s: root element is undefined`,"init",{cause:{manager:this.constructor.name,rootElement:e}});let t=this.form.queryAll(`[${p}-element^="${this.itemType}"]`);this.clear(),t.forEach((r,n)=>{let s=this.createItemData(r,n);s&&this.add(s)}),this.logDebug(`Discovered ${t.length} ${L(this.itemType,t.length)}`,{items:t})}updateItemData(e,t={}){if(typeof e=="number"&&e<0||typeof e=="number"&&e>=this.length)return;let r=this.getBySelector(e);if(!r){this.logWarn(`Cannot update ${this.itemType} data: ${e} not found`);return}let n=this.mergeItemData(r,t);this.update(n)}mergeItemData(e,t){return{...this.buildItemData(e),visited:!0,...t}}rebuildItem(e){let t=this.buildItemData(e);this.update(t)}rebuildActive(){let e=this.getActive();e.length!==0&&e.forEach(t=>{let r=this.buildItemData(t);this.update(r)})}rebuildAll(){this.getAll().forEach(e=>{this.rebuildItem(e)})}determineActive(e,t){let r=this.form.getBehavior(),n=this.findParentItem(e);return n?this.behaviorRequiresFirstChild(r)?n.active&&t===0:n.active:t===0}behaviorRequiresFirstChild(e){return{byField:["field","group","set","card"],byGroup:["group","set","card"],bySet:["set","card"],byCard:["card"]}[e]?.includes(this.itemType)??!1}getActiveIndices(){return this.getByFilter(e=>e.active).map(e=>e.index)}setCurrent(e){let t=this.getBySelector(e);if(!t){this.logWarn(`Cannot set current: ${this.itemType} not found`,{selector:e});return}if(!t.active){this.logWarn(`Cannot set current: ${this.itemType} is not active`,{id:t.id,index:t.index});return}this.clearCurrent(),this.updateItemData(t.index,{current:!0}),this.logDebug(`Set ${this.itemType} "${t.id}" as current`)}clearCurrent(){let e=this.getByFilter(t=>t.current);e.length!==0&&(e.forEach(t=>{this.updateItemData(t.index,{current:!1})}),this.logDebug(`Cleared current flag from ${e.length} ${L(this.itemType,e.length)}`))}clearActiveAndCurrent(){let e=this.getByFilter(t=>t.active||t.current);e.length!==0&&(e.forEach(t=>{let r={...t,active:!1,current:!1};this.update(r)}),this.logDebug(`Cleared active and current flags from ${e.length} ${L(this.itemType,e.length)}`))}setActive(e){let t=this.getBySelector(e);if(!t){this.logWarn(`Cannot set active: ${this.itemType} not found`,{selector:e});return}let r={...t,active:!0};this.update(r),this.logDebug(`Set ${this.itemType} "${t.id}" as active`)}setActiveByParent(e,t,r){let{firstIsCurrent:n=!1}=r??{},s=this.getItemsByParentId(e,t);s.forEach((o,l)=>{let m={...this.buildItemData(o),active:!0,current:l===0&&n};this.update(m)}),this.logDebug(`Set ${s.length} ${L(this.itemType,s.length)} within ${t} "${e}" as active`)}getItemsByParentId(e,t){return this.getByFilter(r=>{if(r.type==="card")return!1;let{parentHierarchy:n}=r;if(!n)return!1;switch(t){case"field":return"fieldId"in n&&n.fieldId===e;case"group":return"groupId"in n&&n.groupId===e;case"set":return"setId"in n&&n.setId===e;case"card":return"cardId"in n&&n.cardId===e;default:return!1}})}findParentByElement(e,t,r){let n=e.closest(`[${p}-element^="${t}"]`);if(!n)return;let o=r().find(l=>l.element===n);if(!o)throw this.createError(`Cannot find parent ${t}: no parent item found`,"init",{cause:{child:e,parentElement:n}});return o}findParentHierarchy(e){return this.itemType==="card"?{formId:this.form.getId()}:g.findParentHierarchy(e,this.form,t=>this.findParentItem(t))}buildNavigationOrder(){this.navigationOrder=this.getByFilter(e=>"isIncluded"in e?e.isIncluded:!0).map(e=>e.index),this.logDebug("Navigation order built")}handleInclusion(e,t){this.getById(e)&&(this.updateItemData(e,{isIncluded:t}),this.buildNavigationOrder(),this.logDebug(`${t?"Included":"Excluded"} ${this.itemType} "${e}"`))}add(e){this.store.add(e)}update(e){this.store.update(e)}merge(e,t){this.store.merge(e,t)}clear(){this.store.clear()}getAll(){return this.store.getAll()}getById(e){return this.store.getById(e)}getByIndex(e){return this.store.getByIndex(e)}getBySelector(e){return this.store.getBySelector(e)}getByDOM(e){return this.store.getByDOM(e)}getByFilter(e){return this.store.filter(e)}getByFind(e){return this.store.find(e)}get length(){return this.store.length}getActive(){return this.getByFilter(e=>e.active)}getAllByParentId(e,t){return this.getByFilter(r=>{if(!("parentHierarchy"in r))return!1;switch(t){case"card":return"cardId"in r.parentHierarchy&&r.parentHierarchy.cardId===e;case"set":return"setId"in r.parentHierarchy&&r.parentHierarchy.setId===e;case"group":return"groupId"in r.parentHierarchy&&r.parentHierarchy.groupId===e;case"field":return"fieldId"in r.parentHierarchy&&r.parentHierarchy.fieldId===e;default:return!1}})}getCurrent(){return this.getByFind(e=>e.current)}getCurrentIndex(){let e=this.getCurrent();return e?e.index:-1}getCurrentId(){return this.getCurrent()?.id}isFirst(){return this.getCurrentIndex()===0}isLast(){return this.getCurrentIndex()===this.length-1}getNavigationOrder(){return this.navigationOrder}getNextPosition(){let e=this.getCurrentIndex();if(e===void 0)return;let t=this.navigationOrder.indexOf(e);if(!(t>=this.navigationOrder.length-1))return this.navigationOrder[t+1]}getPrevPosition(){let e=this.getCurrentIndex();if(e===void 0)return;let t=this.navigationOrder.indexOf(e);if(!(t<=0))return this.navigationOrder[t-1]}setStates(){let e=this.calculateStates();this.form.setStates(e)}};var z=class extends I{constructor(){super(...arguments);a(this,"itemType","card")}createItemData(e,t){if(!(e instanceof HTMLElement))return;let r=e.getAttribute(`${p}-element`);if(!r)return;let n=f(r);if(n.type!==this.itemType)return;let s=k(e,this.itemType,n.id,t),o=!!e.querySelector(`[${p}-element^="set"]`);return{element:e,index:t,id:s.id,visible:!0,active:t===0,type:this.itemType,parentHierarchy:this.findParentHierarchy(e),visited:t===0,completed:!o,current:t===0,title:s.title,progress:o?0:100,isIncluded:!0,isValid:!o}}calculateStates(){let e=this.getCurrent(),t=e?e.index:-1,r=e?e.id:null,n=e?e.title:null,s=t>0?t-1:null,o=t<this.length-1?t+1:null,l=new Set(this.getByFilter(c=>c.completed).map(c=>c.id)),d=new Set(this.getByFilter(c=>c.visited).map(c=>c.id)),m=this.length,v=l.size,b=this.getAll().reduce((c,y)=>(c[y.id]=y.isValid,c),{});return{currentCardIndex:t,currentCardId:r,currentCardTitle:n,activeCardIndices:this.getActiveIndices(),previousCardIndex:s,nextCardIndex:o,completedCards:l,visitedCards:d,totalCards:m,cardsComplete:v,cardValidity:b}}buildItemData(e){let t=this.form.setManager.getAllByParentId(e.id,"card"),r=t.length>0?t.every(d=>d.completed):!0,n=t.length>0?t.every(d=>d.isValid):!0,s=this.form.fieldManager.getAllByParentId(e.id,"card").filter(d=>d.isIncluded),o=s.filter(d=>d.completed).length/s.length*100,l=this.form.conditionManager.evaluateElementCondition(e.element);return{...e,completed:r,isValid:n,progress:o,isIncluded:l}}findParentItem(e){this.logWarn("findParentElement should not be called on CardManager","runtime",{element:e})}};var q=class extends h{constructor(){super(...arguments);a(this,"conditionalElements",new Map);a(this,"affectedElements",new Map)}init(){this.groupStart("Initializing Conditions"),this.discoverConditionalElements(),this.setupEventListeners(),this.logDebug("Initialized",{conditionalElements:this.conditionalElements.size,dependencies:Object.fromEntries(this.affectedElements)}),this.groupEnd()}destroy(){this.conditionalElements.clear(),this.affectedElements.clear(),this.logDebug("ConditionManager destroyed")}discoverConditionalElements(){let e=this.form.getRootElement();if(!e)throw this.createError("Cannot discover conditional elements: root element is null","init",{cause:e});let t=this.form.queryAll(`[${p}-showif], [${p}-hideif]`);this.conditionalElements.clear(),this.affectedElements.clear(),t.forEach(r=>{this.registerCondition(r)}),this.logDebug(`Discovered ${this.conditionalElements.size} conditional elements`,{elements:Array.from(this.conditionalElements.values()),dependencyGraph:Object.fromEntries(this.affectedElements)})}registerCondition(e){let t=e.getAttribute(`${p}-showif`),r=e.getAttribute(`${p}-hideif`);if(!t&&!r)return;let n={element:e,showIfExpression:t?this.parseExpression(t):void 0,hideIfExpression:r?this.parseExpression(r):void 0,dependsOn:new Set};n.showIfExpression&&n.showIfExpression.conditions.forEach(s=>{n.dependsOn.add(s.field),this.addToDependencyGraph(s.field,e)}),n.hideIfExpression&&n.hideIfExpression.conditions.forEach(s=>{n.dependsOn.add(s.field),this.addToDependencyGraph(s.field,e)}),this.conditionalElements.set(e,n)}addToDependencyGraph(e,t){this.affectedElements.has(e)||this.affectedElements.set(e,new Set),this.affectedElements.get(e).add(t)}parseExpression(e){let t=[],r=[],n=e.split(/(\s*(?:&&|\|\|)\s*)/);for(let s=0;s<n.length;s++){let o=n[s].trim();if(o==="&&"||o==="||"){r.push(o);continue}let l=this.parseCondition(o);l&&t.push(l)}return{conditions:t,logicalOperators:r}}parseCondition(e){let t=e.match(/\{([^}]+)\}/);if(!t){this.logWarn(`Invalid condition syntax: ${e}`);return}let r=t[1].trim(),n=e.substring(t.index+t[0].length).trim(),s=n.match(/^(>=|<=|\*=|\^=|\$=|!=|=|>|<)/);if(!s){this.logWarn(`Invalid operator in condition: ${e}`);return}let o=s[1],l=n.substring(o.length).trim();return{field:r,operator:o,value:l}}evaluateElementCondition(e){let t=this.conditionalElements.get(e);if(!t)return!0;let r=!0,n=!1;return t.showIfExpression&&(r=this.evaluateExpression(t.showIfExpression)),t.hideIfExpression&&(n=this.evaluateExpression(t.hideIfExpression)),r&&!n}hasConditions(e){return this.conditionalElements.has(e)}evaluateExpression(e){let{conditions:t,logicalOperators:r}=e;if(t.length===0)return!0;if(t.length===1)return this.evaluateConditionPart(t[0]);let n=this.evaluateConditionPart(t[0]);for(let s=0;s<r.length;s++){let o=r[s],l=t[s+1];if(!l)break;let d=this.evaluateConditionPart(l);o==="&&"?n=n&&d:o==="||"&&(n=n||d)}return n}evaluateConditionPart(e){let{field:t,operator:r,value:n}=e,s=this.getFieldValue(t),o=String(s??"").toLowerCase(),l=n.toLowerCase();switch(r){case"=":return o===l;case"!=":return o!==l;case">":return parseFloat(o)>parseFloat(l);case"<":return parseFloat(o)<parseFloat(l);case">=":return parseFloat(o)>=parseFloat(l);case"<=":return parseFloat(o)<=parseFloat(l);case"*=":return o.includes(l);case"^=":return o.startsWith(l);case"$=":return o.endsWith(l);default:return this.logWarn(`Unknown operator: ${r}`),!1}}getFieldValue(e){let t=this.form.inputManager.getById(e);if(t)return t.value;if(e.startsWith("form.")){let r=e.substring(5);return this.form.getAllState()[r]}this.logWarn(`Field not found: ${e}`)}setupEventListeners(){this.form.subscribe("form:input:changed",e=>{this.onInputChange(e)}),this.logDebug("Event listeners setup")}onInputChange(e){let{name:t}=e,r=this.affectedElements.get(t);!r||r.size===0||(this.logDebug(`Rebuilding ${r.size} affected ${L("element",r.size)}`),this.form.cardManager.rebuildActive(),this.form.setManager.rebuildActive(),this.form.groupManager.rebuildActive(),this.form.fieldManager.rebuildActive(),this.form.inputManager.rebuildActive(),this.form.inputManager.applyStates(),r.forEach(n=>{let s=n.getAttribute(`${p}-element`);if(!s)return;let o=f(s);o&&this.form.emit("form:condition:evaluated",{element:n,type:o.type})}))}getAffectedElements(e){return this.affectedElements.get(e)||new Set}};var G=class extends h{init(){this.groupStart("Initializing Display"),this.setupEventListeners(),this.initializeDisplay(),this.logDebug("Initialized"),this.groupEnd()}destroy(){this.logDebug("DisplayManager destroyed")}setupEventListeners(){this.form.subscribe("form:navigation:changed",i=>{this.updateDisplay(i.target)}),this.form.subscribe("form:condition:evaluated",i=>{let e;switch(i.type){case"card":e=this.form.cardManager;break;case"set":e=this.form.setManager;break;case"group":e=this.form.groupManager;break;case"field":e=this.form.fieldManager;break;default:return}this.handleVisibility(e)}),this.logDebug("DisplayManager event listeners setup")}initializeDisplay(){this.handleVisibility(this.form.cardManager),this.handleVisibility(this.form.setManager),this.handleVisibility(this.form.groupManager),this.handleVisibility(this.form.fieldManager),this.removeInitialStyles()}removeInitialStyles(){this.form.queryAll(`[${p}-initialdisplay]`).forEach(e=>{e.removeAttribute(`${p}-initialdisplay`)})}updateDisplay(i){switch(i){case"card":this.handleVisibility(this.form.cardManager);break;case"set":this.handleVisibility(this.form.setManager);break;case"group":this.handleVisibility(this.form.groupManager);break;case"field":this.handleVisibility(this.form.fieldManager);break;default:return}}handleVisibility(i){i.getAll().forEach(t=>{this.showElement(t,r=>i.updateItemData(t.index,{visible:r}))})}showElement(i,e){let{element:t,active:r,type:n,isIncluded:s}=i,o=r&&s;o?t.style.removeProperty("display"):t.style.setProperty("display","none"),t.setAttribute(`${p}-${n}-active`,r.toString()),t.setAttribute(`${p}-${n}-included`,s.toString()),e(o)}};var _=class extends h{constructor(){super(...arguments);a(this,"store",new S);a(this,"itemType","error")}init(){this.groupStart("Initializing Error"),this.discoverItems(),this.initializeErrors(),this.setupEventListeners(),this.logDebug("Initialized"),this.groupEnd()}destroy(){this.store.clear(),this.logDebug("ErrorManager destroyed")}discoverItems(){let e=this.form.getRootElement();if(!e)throw this.form.createError("Cannot discover error items: root element is null","init",{cause:e});let t=this.form.queryAll(`[${p}-element="error"]`);this.store.clear(),t.forEach((r,n)=>{let s=this.createItemData(r,n);s&&this.store.add(s)}),this.logDebug(`Discovered ${this.store.length} error items`,{items:this.store.getAll()})}createItemData(e,t){if(!(e instanceof HTMLElement))return;let r=e.getAttribute(`${p}-element`);if(!r)return;let n=f(r);if(n&&n.type==="error")return this.buildItemData({element:e,index:t,id:n.id??`error-${t}`,visible:!1,active:!1,type:n.type,parentHierarchy:this.findParentHierarchy(e)})}buildItemData(e){return{...e}}findParentHierarchy(e){return g.findParentHierarchy(e,this.form,t=>this.findParentItem(t))}findParentItem(e){let t=g.findParentByElement(e,"group",()=>this.form.groupManager.getAll()),r=g.findParentByElement(e,"set",()=>this.form.setManager.getAll()),n=g.findParentByElement(e,"card",()=>this.form.cardManager.getAll());return t??r??n}initializeErrors(){this.store.getAll().forEach(e=>{e.element.style.setProperty("display","none")})}setupEventListeners(){this.form.subscribe("form:error:triggered",e=>this.handleErrorTriggered(e)),this.form.subscribe("form:error:cleared",()=>this.handleErrorCleared())}handleErrorTriggered(e){this.store.getAll().forEach(t=>{t.element.textContent=e.message,t.element.style.setProperty("display","flex")}),e.timeout&&setTimeout(()=>{this.handleErrorCleared()},e.timeout)}handleErrorCleared(){this.store.getAll().forEach(e=>{e.element.style.removeProperty("display")})}};var U=class extends I{constructor(){super(...arguments);a(this,"itemType","field")}createItemData(e,t){if(!(e instanceof HTMLElement))return;let r=e.getAttribute(`${p}-element`);if(!r)return;let n=f(r);if(n.type!==this.itemType)return;let s=n.id||`${this.itemType}-${t}`,o=this.findParentItem(e);if(!o)throw this.createError("Cannot discover fields: no parent element found","init",{cause:{manager:"FieldManager",element:e}});let l=this.findParentHierarchy(o),d=this.determineActive(e,t);return{element:e,index:t,id:s,visible:!0,active:d,type:this.itemType,parentHierarchy:l,current:d&&t===0,visited:d,completed:!1,isIncluded:!0,isValid:!1}}calculateStates(){let e=this.getCurrent(),t=e?e.index:-1,r=e?e.id:null,n=t>0?t-1:null,s=t<this.length-1?t+1:null,o=new Set(this.getByFilter(c=>c.completed).map(c=>c.id)),l=new Set(this.getByFilter(c=>c.visited).map(c=>c.id)),d=this.length,m=this.getByFilter(c=>c.isIncluded).length,v=o.size,b=this.getAll().reduce((c,y)=>(c[y.id]=y.isValid,c),{});return{currentFieldIndex:t,currentFieldId:r,activeFieldIndices:this.getActiveIndices(),previousFieldIndex:n,nextFieldIndex:s,completedFields:o,visitedFields:l,totalFields:d,totalIncludedFields:m,fieldsComplete:v,fieldValidity:b}}buildItemData(e){let t=this.form.inputManager.getByFind(o=>o.parentHierarchy.fieldId===e.id);if(!t)throw this.createError("Cannot merge field data: input not found","runtime",{cause:{manager:"FieldManager",element:e,input:t}});let{completed:r,isValid:n}=t,s=this.form.conditionManager.evaluateElementCondition(e.element);return{...e,completed:r,isValid:n,isIncluded:s}}findParentItem(e){let t=g.findParentByElement(e,"group",()=>this.form.groupManager.getAll()),r=g.findParentByElement(e,"set",()=>this.form.setManager.getAll());return t??r}};var W=class extends h{constructor(){super(...arguments);a(this,"handleNavigationChanged",()=>{let e=this.form.getState("currentFieldIndex");if(e<0)return;let t=this.form.inputManager.getByIndex(e);!t||!t.active||this.focusElement(t.element)});a(this,"handleNavigationDenied",()=>{let e=this.form.inputManager.getByFilter(r=>r.active&&r.isIncluded);if(e.length===0)return;let t=e.find(r=>!r.isValid);t&&this.focusElement(t.element)})}init(){this.setupEventListeners()}destroy(){}setupEventListeners(){this.form.subscribe("form:navigation:changed",()=>{this.handleNavigationChanged()}),this.form.subscribe("form:navigation:denied",()=>{this.handleNavigationDenied()})}isFocusable(e){return!e.hasAttribute("disabled")&&e.offsetParent!==null&&e.tabIndex>=0}focusElement(e,t=!0){if(!this.isFocusable(e))return!1;try{return e.focus(),t&&e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),!0}catch(r){return this.logError("Failed to focus element",r),!1}}};var j=class extends I{constructor(){super(...arguments);a(this,"itemType","group")}createItemData(e,t){if(!(e instanceof HTMLElement))return;let r=e.getAttribute(`${p}-element`);if(!r)return;let n=f(r);if(n.type!==this.itemType)return;let s=k(e,this.itemType,n.id,t),o=this.findParentHierarchy(e),l=this.determineActive(e,t);return{element:e,index:t,id:s.id,visible:!0,active:l,type:this.itemType,parentHierarchy:o,current:l&&t===0,visited:l,completed:!1,title:s.title,progress:0,isIncluded:!0,isValid:!1}}calculateStates(){let e=this.getCurrent(),t=e?e.index:-1,r=e?e.id:null,n=e?e.title:null,s=t>0?t-1:null,o=t<this.length-1?t+1:null,l=new Set(this.getByFilter(c=>c.completed).map(c=>c.id)),d=new Set(this.getByFilter(c=>c.visited).map(c=>c.id)),m=this.length,v=l.size,b=this.getAll().reduce((c,y)=>(c[y.id]=y.isValid,c),{});return{currentGroupIndex:t,currentGroupId:r,currentGroupTitle:n,activeGroupIndices:this.getActiveIndices(),previousGroupIndex:s,nextGroupIndex:o,completedGroups:l,visitedGroups:d,totalGroups:m,groupsComplete:v,groupValidity:b}}buildItemData(e){let t=this.form.fieldManager.getAllByParentId(e.id,"group").filter(l=>l.isIncluded),r=t.every(l=>l.completed),n=t.every(l=>l.isValid),s=t.filter(l=>l.completed).length/t.length*100,o=this.form.conditionManager.evaluateElementCondition(e.element);return{...e,completed:r,isValid:n,progress:s,isIncluded:o}}findParentItem(e){return g.findParentByElement(e,"set",()=>this.form.setManager.getAll())}};var J=class extends I{constructor(){super(...arguments);a(this,"itemType","input");a(this,"activeListeners",[])}init(){super.init(!1),this.setupEventListeners(),this.onInitialized()}destroy(){this.unbindAllInputs(),super.destroy()}discoverItems(){let e=this.form.fieldManager.getAll();this.clear();let t=new Set;e.forEach((r,n)=>{let s=Array.from(r.element.querySelectorAll("input, select, textarea"));if(s.length===0){this.form.logWarn(`Field "${r.id}" has no inputs`,{field:r});return}let o=this.findParentHierarchy(r);s.forEach(l=>{let d=this.createInputData(l,n,{field:r,processedNames:t,parentHierarchy:o,isGroup:s.length>1});d&&this.update(d)})}),this.logDebug(`Discovered ${this.length} ${this.itemType}s`,{elements:this.getAll()})}createItemData(){}createInputData(e,t,r){let{field:n,processedNames:s,parentHierarchy:o,isGroup:l}=r,d=e.getAttribute("name");if(!d)throw this.createError("Cannot discover inputs: Input missing name attribute","init",{cause:{input:e,field:o.fieldId,group:o.groupId,set:o.setId,card:o.cardId,form:o.formId}});if(s.has(d)){let E=this.getById(d);E&&(E.inputs.push(e),E.isGroup=E.inputs.length>1,this.mergeItemData(E,{}));return}s.add(d);let m=this.getInputType(e),v=this.checkIfRequired(e),b=this.checkIfValid(e),{visited:c,active:y,current:ue,isIncluded:ee}=n,P=e.getAttribute(`${p}-format`)||void 0,me;if(P&&(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)){let{formattedLength:E,rawLength:de}=this.calculateFormatLengths(P),D=e.maxLength>-1?e.maxLength:null;D!==null&&D<E?e.maxLength=E:D!==null&&D>de?e.maxLength=D-de+E:e.maxLength=E,e.minLength=E,me={pattern:P,formattedLength:E,rawLength:de,originalMaxLength:D}}return{element:e,index:t,id:d,visible:!0,active:y,type:"input",parentHierarchy:o,current:ue,visited:c,completed:b,inputs:[e],inputType:m,value:this.getInputValue(e),name:d,isGroup:l,isRequiredOriginal:v,isRequired:v,isValid:b,isIncluded:ee,format:P,formatConfig:me}}calculateStates(){return{formData:this.getFormData()}}buildItemData(e){let t=this.form.fieldManager.getById(e.parentHierarchy.fieldId),r=t?t.isIncluded:!0,n=r?e.isRequiredOriginal:!1;n!==e.isRequired&&this.setInputRequired(e,n);let s=this.checkIfValid(e.element);return{...e,completed:s,value:this.getValue(e.name),isIncluded:r,isRequired:n,isValid:s}}applyStates(){this.getAll().forEach(e=>{e.inputs.forEach(t=>{t.required=e.isRequired})})}setupEventListeners(){this.bindActiveInputs(),this.form.subscribe("form:navigation:changed",e=>{e.target==="field"&&this.handleActiveFieldsChanged()})}handleActiveFieldsChanged(){this.bindActiveInputs(),this.unbindInactiveInputs()}bindActiveInputs(){let e=this.getActive();e.length!==0&&e.forEach(t=>{if(t.inputs.some(s=>this.activeListeners.some(o=>o.element===s)))return;let n=this.getEventTypeForInput(t.element);t.inputs.forEach(s=>{let o=t.format&&(s instanceof HTMLInputElement||s instanceof HTMLTextAreaElement),l=()=>{o&&this.handleFormatting(s,t.format,t);let d=this.extractInputValue(t);this.handleInputChange(t.name,d)};s.addEventListener(n,l),this.activeListeners.push({element:s,index:t.index,name:t.name,event:n,handler:l})}),this.logDebug(`Bound "${n}" events to input "${t.name}"`)})}unbindInactiveInputs(){let e=this.getActive();e.length!==0&&(this.activeListeners=this.activeListeners.filter(t=>{let r=!e.find(n=>n.index===t.index);return r&&(t.element.removeEventListener(t.event,t.handler),this.logDebug(`Unbound "${t.event}" events from input "${t.name}"`)),!r}))}unbindAllInputs(){this.activeListeners.forEach(e=>{e.element.removeEventListener(e.event,e.handler)}),this.activeListeners=[]}getEventTypeForInput(e){if(e instanceof HTMLSelectElement)return"change";if(e instanceof HTMLTextAreaElement)return"input";let t=e.type.toLowerCase();return["radio","checkbox"].includes(t)?"change":"input"}extractInputValue(e){let{element:t}=e;if(t instanceof HTMLSelectElement)return t.value;if(t instanceof HTMLTextAreaElement)return e.format?this.stripFormatting(t.value):t.value;let r=e.inputType;if(r==="checkbox")return e.isGroup?e.inputs.filter(n=>n.checked).map(n=>n.value).join(", "):t.checked;if(r==="radio"){let n=e.inputs.find(s=>s.checked);return n?n.value:null}return t.value}getValue(e){let t=this.getBySelector(e);if(t)return t.value}getInputValue(e){if(e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement)return e.value;let t=e.type.toLowerCase();return t==="checkbox"||t==="radio"?e.checked:e.value}setValue(e,t){let r=this.getBySelector(e);if(!r){this.form.logWarn(`Cannot set value for input "${e}" - not found`);return}let{element:n}=r;if(n instanceof HTMLSelectElement||n instanceof HTMLTextAreaElement){n.value=String(t);return}let s=r.inputType;if(s==="checkbox"){Array.isArray(t)?r.inputs.forEach(o=>{o.checked=t.includes(o.value)}):n.checked=!!t;return}if(s==="radio"){r.inputs.forEach(o=>{o.checked=o.value===String(t)});return}n.value=String(t)}getFormData(){let e={};return this.getByFilter(t=>t.isIncluded).forEach(t=>{e[t.name]=this.extractInputValue(t)}),e}calculateFormatLengths(e){let t=(e.match(/[Xx]/g)||[]).length;return{formattedLength:e.length,rawLength:t}}updateLengthConstraints(e,t,r){if(!t.formatConfig)return;let{formattedLength:n,rawLength:s,originalMaxLength:o}=t.formatConfig;if(r<=s){let d;o!==null&&o>s?d=o-s+n:d=n,e.maxLength!==d&&(e.maxLength=d),e.minLength!==n&&(e.minLength=n)}else{e.minLength!==s&&(e.minLength=s);let d=o!==null?o:-1;e.maxLength!==d&&(e.maxLength=d)}}handleFormatting(e,t,r){let n=e.selectionStart||0,s=e.value,o=this.stripFormatting(s);this.updateLengthConstraints(e,r,o.length);let l=this.applyFormat(o,t);if(l!==s){e.value=l;let d=this.calculateCursorPosition(s,l,n);e.setSelectionRange(d,d)}}stripFormatting(e){return e.replace(/\D/g,"")}applyFormat(e,t){let r=(t.match(/[Xx]/g)||[]).length;if(e.length>r)return e;let n="",s=0;for(let o=0;o<t.length&&s<e.length;o++){let l=t[o];l==="X"||l==="x"?(n+=e[s],s+=1):n+=l}return n}calculateCursorPosition(e,t,r){let n=e.slice(0,r).replace(/\D/g,"").length,s=0,o=0;for(let l=0;l<t.length;l++)if(/\d/.test(t[l])&&(s+=1,s===n)){o=l+1;break}return s<n&&(o=t.length),o}handleInputChange(e,t){this.logDebug(`Input "${e}" changed to "${t}"`),this.updateItemData(e,{value:t});let r=this.form.getState("formData");this.form.setState("formData",{...r,[e]:t}),this.form.emit("form:input:changed",{name:e,value:t}),this.logDebug("Form data updated",{formData:this.form.getState("formData")})}setInputRequired(e,t){e.isRequired=t,e.inputs.forEach(r=>{r.required=t})}findParentItem(e){let t=g.findParentByElement(e,"field",()=>this.form.fieldManager.getAll());if(!t)throw this.createError("Cannot discover inputs: no parent field found","init",{cause:{manager:"InputManager",element:e}});return t}getInputType(e){return e instanceof HTMLSelectElement?"select":e instanceof HTMLTextAreaElement?"textarea":e.type.toLowerCase()}checkIfRequired(e){return e.required}checkIfValid(e){if(e instanceof HTMLInputElement){let{minLength:t,maxLength:r,value:n}=e;if(t>-1&&n.length<t||r>-1&&n.length>r)return!1}return e.checkValidity()}};var Y=class extends h{constructor(){super(...arguments);a(this,"navigationEnabled",!0);a(this,"enterKeyHandler",null)}init(){this.groupStart("Initializing Navigation"),this.setupEventListeners(),this.form.logDebug("Initialized"),this.groupEnd()}destroy(){this.removeEventListeners(),this.form.logDebug("NavigationManager destroyed")}setupEventListeners(){this.form.subscribe("form:navigation:request",e=>{this.handleMove(e.type)}),this.setupEnterKeyListener(),this.form.logDebug("Event listeners setup")}removeEventListeners(){this.enterKeyHandler&&(document.removeEventListener("keydown",this.enterKeyHandler),this.enterKeyHandler=null)}setupEnterKeyListener(){this.enterKeyHandler=e=>{if(e.key!=="Enter"||e.shiftKey)return;this.form.logDebug("Enter key pressed",{event:e});let t=this.form.getRootElement(),{activeElement:r}=document;if(!t.contains(r)&&r!==document.body||r?.tagName==="BUTTON")return;e.preventDefault(),this.form.buttonManager.determineNextOrSubmit()==="next"?this.form.emit("form:navigation:request",{type:"next"}):this.form.emit("form:submit:requested",{})},document.addEventListener("keydown",this.enterKeyHandler),this.form.logDebug("Global Enter key listener setup")}handleMove(e){if(!this.navigationEnabled)return;let t=e==="next"&&this.validateCurrent()||e==="submit"&&this.validateCurrent()||e==="prev",r=this.form.getBehavior(),n=r.toLowerCase().replace("by","");if(t)this.logDebug(`Navigating to ${e} ${n}`);else{this.logDebug(`Cannot navigate to ${e} ${n}`),this.form.emit("form:navigation:denied",{reason:"invalid"});return}if(e==="submit"){this.byCard("next");return}switch(r){case"byField":this.byField(e);break;case"byGroup":this.byGroup(e);break;case"bySet":this.bySet(e);break;case"byCard":this.byCard(e);break;default:throw this.form.createError("Invalid behavior","runtime",{cause:{behavior:r}})}}validateCurrent(){return this.form.inputManager.getByFilter(t=>t.active&&t.isIncluded).every(t=>t.isValid)}byField(e){let t=e==="prev"?this.form.fieldManager.getPrevPosition():this.form.fieldManager.getNextPosition();if(t===void 0)return this.byGroup(e);let r=this.form.fieldManager.getByIndex(t);if(!r)throw this.form.createError("Cannot handle navigation: target field is null","runtime",{cause:{targetPosition:t,targetField:r,direction:e}});return this.clearHierarchyData("field"),this.setChildrenActive(r),this.updateHierarchyData(r),this.batchStateUpdates(),"field"}byGroup(e){let t=e==="prev"?this.form.groupManager.getPrevPosition():this.form.groupManager.getNextPosition();if(t===void 0)return this.bySet(e);let r=this.form.groupManager.getByIndex(t);if(!r)throw this.form.createError("Cannot handle navigation: target group is null","runtime",{cause:{targetPosition:t,targetGroup:r,direction:e}});return this.clearHierarchyData("group"),this.form.groupManager.setActive(r.id),this.form.groupManager.setCurrent(r.id),this.setChildrenActive(r),this.updateHierarchyData(r),this.batchStateUpdates(),"group"}bySet(e){let t=e==="prev"?this.form.setManager.getPrevPosition():this.form.setManager.getNextPosition();if(t===void 0)return this.byCard(e);let r=this.form.setManager.getByIndex(t);if(!r)throw this.form.createError("Cannot handle navigation: target set is null","runtime",{cause:{targetPosition:t,targetSet:r,direction:e}});return this.clearHierarchyData("set"),this.form.setManager.setActive(r.id),this.form.setManager.setCurrent(r.id),this.setChildrenActive(r),this.updateHierarchyData(r),this.batchStateUpdates(),"set"}byCard(e){let t=e==="prev"?this.form.cardManager.getPrevPosition():this.form.cardManager.getNextPosition();if(t===void 0)return;let r=this.form.cardManager.getByIndex(t);if(!r)throw this.form.createError("Cannot handle navigation: target card is null","runtime",{cause:{targetPosition:t,targetCard:r,direction:e}});return this.clearHierarchyData("card"),this.form.cardManager.setActive(r.id),this.form.cardManager.setCurrent(r.id),this.setChildrenActive(r),this.batchStateUpdates(),"card"}clearHierarchyData(e){e==="card"&&this.form.cardManager.clearActiveAndCurrent(),(e==="card"||e==="set")&&this.form.setManager.clearActiveAndCurrent(),(e==="card"||e==="set"||e==="group")&&this.form.groupManager.clearActiveAndCurrent(),this.form.fieldManager.clearActiveAndCurrent()}setChildrenActive(e){e.type==="card"&&this.form.setManager.setActiveByParent(e.id,e.type,{firstIsCurrent:!0}),(e.type==="card"||e.type==="set")&&this.form.groupManager.setActiveByParent(e.id,e.type,{firstIsCurrent:!0}),(e.type==="card"||e.type==="set"||e.type==="group")&&this.form.fieldManager.setActiveByParent(e.id,e.type,{firstIsCurrent:!0}),this.form.inputManager.clearActiveAndCurrent(),this.form.fieldManager.getActive().forEach((r,n)=>{this.form.inputManager.setActiveByParent(r.id,"field",{firstIsCurrent:n===0})})}updateHierarchyData(e){if(e.type==="field"){let{groupIndex:r}=e.parentHierarchy;r!==null&&r>=0&&(this.form.groupManager.clearActiveAndCurrent(),this.form.groupManager.setActive(r),this.form.groupManager.setCurrent(r))}if(e.type==="field"||e.type==="group"){let{setIndex:r}=e.parentHierarchy;r!==null&&r>=0&&(this.form.setManager.clearActiveAndCurrent(),this.form.setManager.setActive(r),this.form.setManager.setCurrent(r))}let{cardIndex:t}=e.parentHierarchy;t!==null&&t>=0&&(this.form.cardManager.clearActiveAndCurrent(),this.form.cardManager.setActive(t),this.form.cardManager.setCurrent(t))}batchStateUpdates(){this.form.inputManager.rebuildAll(),this.form.fieldManager.rebuildAll(),this.form.groupManager.rebuildAll(),this.form.setManager.rebuildAll(),this.form.cardManager.rebuildAll();let e={...this.form.inputManager.calculateStates(),...this.form.fieldManager.calculateStates(),...this.form.groupManager.calculateStates(),...this.form.setManager.calculateStates(),...this.form.cardManager.calculateStates()};this.form.setStates(e)}};var ae=class ae extends h{constructor(){super(...arguments);a(this,"store",new S)}init(){this.groupStart("Initializing Progress"),this.discoverItems(),this.setupEventListeners(),this.logDebug("Initialized"),this.groupEnd()}destroy(){this.store.clear(),this.logDebug("ProgressManager destroyed")}discoverItems(){let e=this.form.getRootElement();if(!e)throw this.form.createError("Cannot discover progress items: root element is null","init",{cause:e});let t=this.form.queryAll(`[${p}-element="progress-line"]`);this.store.clear(),t.forEach((r,n)=>{let s=this.createItemData(r,n);s&&this.store.add(s)}),this.logDebug(`Discovered ${this.store.length} progress lines`,{items:this.store.getAll()})}createItemData(e,t){if(!(e instanceof HTMLElement))return;let r=e.getAttribute(`${p}-element`);if(!r)return;let n=f(r);if(n&&n.type==="progress-line")return this.buildItemData({element:e,index:t,id:n.id??`progress-line-${t}`,visible:!0,active:!1,type:n.type,parentHierarchy:this.findParentHierarchy(e)})}buildItemData(e){return{...e,active:!0}}findParentHierarchy(e){return g.findParentHierarchy(e,this.form,t=>this.findParentItem(t))}findParentItem(e){let t=g.findParentByElement(e,"group",()=>this.form.groupManager.getAll()),r=g.findParentByElement(e,"set",()=>this.form.setManager.getAll()),n=g.findParentByElement(e,"card",()=>this.form.cardManager.getAll());return t??r??n}setupEventListeners(){this.form.subscribe("form:navigation:changed",()=>{this.updateProgress()})}updateProgress(){this.store.getAll().forEach(e=>{let t=this.getProgressForBehavior(e);t!==void 0&&e.element.style.setProperty("--progress",t.toString())})}getProgressForBehavior(e){let t=this.form.getBehavior(),{parentHierarchy:r}=e,n=this.getParentContext(r);if(!n)return;let[s,o]=n,l=ae.PROGRESS_CONFIG[s]?.[t];if(!l)return;let{manager:d,parentType:m,stateKey:v}=l,b=this.form[d],c=m==="form"?b.getAll():b.getAllByParentId(o,m);if(c.length===0)return;let ue=this.form.getAllState()[v],ee=c.findIndex(P=>P.index===ue);if(ee!==-1)return(ee+1)/c.length*100}getParentContext(e){if("setId"in e&&e.setId)return["set",e.setId];if("cardId"in e&&e.cardId)return["card",e.cardId];if(e.formId)return["form",e.formId]}};a(ae,"PROGRESS_CONFIG",{form:{byCard:{manager:"cardManager",parentType:"form",stateKey:"currentCardIndex"},bySet:{manager:"setManager",parentType:"form",stateKey:"currentSetIndex"},byGroup:{manager:"groupManager",parentType:"form",stateKey:"currentGroupIndex"},byField:{manager:"fieldManager",parentType:"form",stateKey:"currentFieldIndex"}},card:{bySet:{manager:"setManager",parentType:"card",stateKey:"currentSetIndex"},byGroup:{manager:"groupManager",parentType:"card",stateKey:"currentGroupIndex"},byField:{manager:"fieldManager",parentType:"card",stateKey:"currentFieldIndex"}},set:{byGroup:{manager:"groupManager",parentType:"set",stateKey:"currentGroupIndex"},byField:{manager:"fieldManager",parentType:"set",stateKey:"currentFieldIndex"}}});var Q=ae;var X=class extends I{constructor(){super(...arguments);a(this,"itemType","set")}createItemData(e,t){if(!(e instanceof HTMLElement))return;let r=e.getAttribute(`${p}-element`);if(!r)return;let n=f(r);if(n.type!==this.itemType)return;let s=k(e,this.itemType,n.id,t),o=this.findParentHierarchy(e),l=this.determineActive(e,t);return{element:e,index:t,id:s.id,visible:!0,active:l,parentHierarchy:o,current:l&&t===0,visited:l,completed:!1,type:this.itemType,title:s.title,progress:0,isIncluded:!0,isValid:!1}}calculateStates(){let e=this.getCurrent(),t=e?e.index:-1,r=e?e.id:null,n=e?e.title:null,s=t>0?t-1:null,o=t<this.length-1?t+1:null,l=new Set(this.getByFilter(c=>c.completed).map(c=>c.id)),d=new Set(this.getByFilter(c=>c.visited).map(c=>c.id)),m=this.length,v=l.size,b=this.getAll().reduce((c,y)=>(c[y.id]=y.isValid,c),{});return{currentSetIndex:t,currentSetId:r,currentSetTitle:n,activeSetIndices:this.getActiveIndices(),previousSetIndex:s,nextSetIndex:o,completedSets:l,visitedSets:d,totalSets:m,setsComplete:v,setValidity:b}}buildItemData(e){let t=this.form.groupManager.getAllByParentId(e.id,"set"),r=this.form.fieldManager.getAllByParentId(e.id,"set").filter(m=>m.isIncluded),n=t.length>0?t:r,s=n.every(m=>m.completed),o=n.every(m=>m.isValid),l=n.filter(m=>m.completed).length/n.length*100,d=this.form.conditionManager.evaluateElementCondition(e.element);return{...e,completed:s,isValid:o,progress:l,isIncluded:d}}findParentItem(e){return g.findParentByElement(e,"card",()=>this.form.cardManager.getAll())}};var Z=class extends h{constructor(e){super(e);a(this,"formElement");this.formElement=this.discoverForm()}init(){this.groupStart("Initializing Submit"),this.discoverForm(),this.setupEventListeners(),this.logDebug("Initialized",{formElement:this.formElement}),this.groupEnd()}destroy(){this.logDebug("SubmitManager destroyed")}setupEventListeners(){this.form.subscribe("form:submit:requested",()=>{this.handleSubmit()}),this.formElement.addEventListener("submit",e=>{e.preventDefault(),this.handleSubmit()}),this.form.subscribe("form:submit:error",e=>{this.logDebug("Form submit error",{error:e.error}),this.showError(e.error.message)})}discoverForm(){let e=this.form.getRootElement();if(!e)throw this.form.createError("Cannot discover form: root element is null","init",{cause:e});let t;if(e instanceof HTMLFormElement)t=e;else{let r=e.querySelector("form");if(!r)throw this.form.createError("Cannot discover form: child form is null","init",{cause:e});t=r}return t}handleSubmit(){this.logDebug("Form submit requested",{data:this.form.getState("formData")}),this.form.emit("form:submit:started",{})}setLoading(e){let t=this.form.buttonManager.getSubmit();t&&(t.button.disabled=e,this.form.buttonManager.setText(t.button,e?"Submitting...":void 0))}showSuccess(){this.form.emit("form:navigation:request",{type:"submit"})}showError(e,t){this.form.emit("form:error:triggered",{message:e,timeout:t})}};var le=class extends se{constructor(e){super(e);a(this,"config");a(this,"submitManager");a(this,"errorManager");a(this,"cardManager");a(this,"setManager");a(this,"groupManager");a(this,"fieldManager");a(this,"inputManager");a(this,"buttonManager");a(this,"navigationManager");a(this,"displayManager");a(this,"progressManager");a(this,"focusManager");a(this,"conditionManager");this.setRootElement(e.selector),this.config=this.parseConfiguration(),this.submitManager=new Z(this),this.errorManager=new _(this),this.cardManager=new z(this),this.setManager=new X(this),this.groupManager=new j(this),this.fieldManager=new U(this),this.inputManager=new J(this),this.buttonManager=new N(this),this.navigationManager=new Y(this),this.displayManager=new G(this),this.progressManager=new Q(this),this.focusManager=new W(this),this.conditionManager=new q(this),this.config.autoInit&&!this.isInitialized()&&this.init()}parseConfiguration(){let e=be(this.rootElement);if(!e.name)throw this.createError("Invalid configuration: No name is provided for form","init",{cause:{element:this.rootElement,name:e.name}});if(e.behavior&&!Ee(e.behavior))throw this.createError("Invalid configuration: Behavior must be 'byField', 'bySet', 'byGroup', or 'byCard'","init",{cause:{behavior:e.behavior}});if(e.transition&&!Se(e.transition))throw this.createError('Invalid configuration: Transition must be "fade", "slide", or "none"',"init",{cause:{transition:e.transition}});if(e.transitionduration&&isNaN(parseFloat(e.transitionduration)))throw this.createError("Invalid configuration: Transition duration must be a number","init",{cause:{transitionDuration:e.transitionduration}});if(e.allowinvalid&&!["true","false",""].includes(e.allowinvalid))throw this.createError("Invalid configuration: Allow invalid must be 'true' or 'false'","init",{cause:{allowInvalid:e.allowinvalid}});if(e.errordisplay&&!Ie(e.errordisplay))throw this.createError("Invalid configuration: Error display mode must be 'native'","init",{cause:{errordisplay:e.errordisplay}});if(e.ariaannounce&&!["true","false",""].includes(e.ariaannounce))throw this.createError("Invalid configuration: Aria announce must be 'true' or 'false'","init",{cause:{ariaAnnounce:e.ariaannounce}});if(e.focusonchange&&!["true","false",""].includes(e.focusonchange))throw this.createError("Invalid configuration: Focus on change must be 'true' or 'false'","init",{cause:{focusOnChange:e.focusonchange}});if(e.autoinit&&!["true","false",""].includes(e.autoinit))throw this.createError("Invalid configuration: Auto init must be 'true' or 'false'","init",{cause:{autoInit:e.autoinit}});if(e.persist&&!Te(e.persist))throw this.createError("Invalid configuration: Persist must be 'memory'","init",{cause:{persist:e.persist}});let t=!1;return e.debug==="staging"?t=window.location.hostname.includes("webflow.io"):e.debug&&["true","false",""].includes(e.debug)&&(t=B(e.debug,!1)),this.props.debug=t,{name:e.name||"untitled-form",behavior:e.behavior||"byField",transition:e.transition||"none",transitionDuration:Me(e.transitionduration,300),validateOn:e.validateon||"blur",allowInvalid:B(e.allowinvalid,!1),errorDisplay:e.errordisplay||"native",ariaAnnounce:B(e.ariaannounce,!0),focusOnChange:B(e.focusonchange,!0),autoInit:B(e.autoinit,!1),persist:e.persist||"memory",debug:t}}async setupEventListeners(){}async onInit(){await super.onInit(),this.groupStart(`[FLOWUPS-DEBUG] Form: Initializing "${this.getId()}"`,!1),this.logDebug(`Started at ${new Date().toISOString()}`),this.timeDebug("form:init"),this.submitManager.init(),this.errorManager.init(),this.conditionManager.init(),this.cardManager.init(),this.setManager.init(),this.groupManager.init(),this.fieldManager.init(),this.inputManager.init(),this.buttonManager.init(),this.displayManager.init(),this.navigationManager.init(),this.progressManager.init(),this.focusManager.init(),this.logDebug("Form initialized",{state:this.getAllState(),timestamp:new Date().toISOString()}),this.emit("form:initialized",{formId:this.getId()}),this.timeDebug("form:init",!0),this.groupEnd()}async onDestroy(){this.logDebug("Destroying form"),this.submitManager.destroy(),this.errorManager.destroy(),this.cardManager.destroy(),this.setManager.destroy(),this.groupManager.destroy(),this.fieldManager.destroy(),this.inputManager.destroy(),this.navigationManager.destroy(),this.displayManager.destroy(),this.buttonManager.destroy(),this.progressManager.destroy(),this.focusManager.destroy(),this.conditionManager.destroy(),await super.onDestroy(),this.emit("form:destroyed",{formId:this.getId()})}handleStateChange(e,t,r){switch(e){case"currentCardIndex":return this.emit("form:navigation:changed",{target:"card"});case"currentSetIndex":return this.emit("form:navigation:changed",{target:"set"});case"currentGroupIndex":return this.emit("form:navigation:changed",{target:"group"});case"currentFieldIndex":return this.emit("form:navigation:changed",{target:"field"});case"activeFieldIndices":return this.emit("form:navigation:changed",{target:"field"});default:return}}getFormName(){return this.config.name}getBehavior(){return this.config.behavior}getFormConfig(){return Object.freeze({...this.config})}getState(e){return super.getState(e)}};var Le=window.MotifForm||[];window.Webflow||(window.Webflow=[]);window.Webflow.push(()=>{let u=document.querySelector(`form[${p}-element="form"]`);if(!u||!(u instanceof HTMLFormElement))return;let i=u.getAttribute("name")??"untitled-form",e=new le({selector:u}),t=()=>{Le.forEach(r=>r())};window.MotifForm={id:e.getFormName(),getAllState:()=>e.getAllState(),getBehavior:()=>e.getBehavior(),getFormConfig:()=>e.getFormConfig(),getFormData:()=>e.getState("formData"),setLoading:r=>{e.submitManager.setLoading(r)},showSuccess:()=>{e.submitManager.showSuccess()},showError:(r,n)=>{e.submitManager.showError(r,n)},onSubmit:r=>{e.subscribe("form:submit:started",()=>{let n=e.getState("formData");r(n)})},onMount:r=>{e.isInitialized()?r():e.subscribe("form:initialized",({formId:n})=>{n===i&&r()})},onUnmount:r=>{e.subscribe("form:destroyed",({formId:n})=>{n===i&&r()})},push:r=>{r()}},e.isInitialized()?t():e.subscribe("form:initialized",()=>{t()})});})();
